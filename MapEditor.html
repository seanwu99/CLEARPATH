<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="lib/fabric.js"></script>
    <title>MapEditor Demo</title>

    <script id="sap-ui-bootstrap"
            src="https://sapui5.netweaver.ondemand.com/resources/sap-ui-core.js"
            data-sap-ui-theme="sap_bluecrystal"
            data-sap-ui-libs="sap.m"
            data-sap-ui-language="en">
    </script>

    <script>
        var mData;
        var mJson;
        var mMap;
        $(function () {
//            document.getElementById('files').addEventListener('change', handleFileSelect, false);
            mData = {
                title: "mName",
                features: [
                    {
                        type: "Feature",
                        properties: {unitName: "ABCD", unitID: "1234"},
                        geometry: {
                            type: "Polygon",
                            coordinates: [[[0, 0]]]
                        }
                    },

                ]
            };
            mJson = Highcharts.geojson(mData);

            $.each(mJson, function (i) {
                this.value = 60 + Math.round((Math.random() * 40)); // random bogus data
            });

            // Instanciate the map
            mapInit(mJson);

        });

        function mapInit(_myJson) {
            mMap = new Highcharts.Map('container', {
                chart: {


                    events: {
                        drilldown: function (e) {
                        },
                        drillup: function () {
                        }
                    }
                },

                title: {
                    text: 'mMap'
                },

//                subtitle: {
//                    text: 'subtitle',
//                    floating: true,
//                    align: 'right',
//                    y: 50,
//                    style: {
//                        fontSize: '16px'
//                    }
//                },

//                legend: small ? {} : {
//                    layout: 'vertical',
//                    align: 'right',
//                    verticalAlign: 'middle'
//                },

                colorAxis: {
                    showInLegend: false,
                    min: 0,
                    minColor: '#E6E7E8',
                    maxColor: '#005645'
                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'top'
                    }
                },

                plotOptions: {
                    map: {
                        states: {
                            hover: {
                                color: '#EEDD66'
                            }
                        }
                    }
                },

                series: [{
                    borderWidth: 0,
                    data: mJson,
                    name: 'mSeries',
                    dataLabels: {
                        enabled: true,
//                        format: '{point.properties.postal-code}'
                    }
                }],

                drilldown: {
//                    //series: drilldownSeries,
                    activeDataLabelStyle: {
                        color: '#FFFFFF',
                        textDecoration: 'none',
                        textShadow: '0 0 3px #000000'
                    },
//                    drillUpButton: {
//                        relativeTo: 'spacingBox',
//                        position: {
//                            x: 0,
//                            y: 60
//                        }
//                    }
                }
            });
        }
    </script>
</head>
<body>

<!--<output id="list"></output>-->

<script>


</script>

<button id="Rect">Rec</button>
<button id="Circle">Cir</button>
<button id="Triangle">Tri</button>
<button id="remove">Del</button>
<button id="Map">Map</button>
<!--<button id="BG">tt</button>-->
<input id="file" type="file" style="display: none;" onchange="handleFiles(this.files)">
<button id="button">BG</button>
<!--<input type="file" id="input" onchange="handleFiles(this.files)" color="#fff">-->
ID: <input type="text" id='Units' name="ID" value="">


<!--<canvas id="hCanvas" width="500" height="200" style="border: 1px solid #aaa"></canvas>-->
<canvas id="hCanvas" width="500" height="100" class="lower-canvas"
        style="position: absolute; width: 500px; height: 100px; left: 0px; top: 0px; -webkit-user-select: none;"></canvas>
<script id="main">
    // 		(function() {
//    input[type="file"]{
//        color:#fff;
//    }
    $('#button').click(function(){
        $('#file').click();
    });
    var fabricCanvas = new fabric.Canvas('hCanvas');
    fabricCanvas.on('mouse:down', function (options) {
        console.log('canvas event');
        console.log(options);
        var hasSelect = false;
        if (fabricCanvas.getActiveObject() == null) {
            cc('null');
            document.getElementById("Units").value = '';
            document.getElementById('Units').disabled = true;
        } else {
            document.getElementById('Units').disabled = false;
        }

    });

    var Units = [];

    function handleFiles(files) {
//        var ctx = document.getElementById('c').getContext('2d');
//        var oldCanvas = canvas.toDataURL("image/png");
        var fileList = this.files;
        cc(files[0]);
        var image = new Image();
        image.src = window.URL.createObjectURL(files[0]);
        image.onload = function () {
            fabricCanvas.setDimensions({width: image.width, height: image.height}, {backstoreOnly: true});
            fabricCanvas.setDimensions({width: image.width + 'px', height: image.height + 'px'}, {cssOnly: true});
            fabricCanvas.setBackgroundImage(image.src, fabricCanvas.renderAll.bind(fabricCanvas));
        }
    }
    function setBackground(URL) {
        var image = new Image();
        image.src = URL;
        image.onload = function () {
//            var ctx = document.getElementById('c').getContext('2d');
//            var oldCanvas = canvas.toDataURL("image/png");
            fabricCanvas.setDimensions({width: image.width, height: image.height}, {backstoreOnly: true});
            fabricCanvas.setDimensions({width: image.width + 'px', height: image.height + 'px'}, {cssOnly: true});
            fabricCanvas.setBackgroundImage(image.src, fabricCanvas.renderAll.bind(fabricCanvas));
        }
    }
    $('#Rect').click(function () {
        fabricCanvas.add(new fabric.Rect({
            width: 100,
            height: 100,
            left: 0,
            top: 0,
            angle: 0,
            fill: 'rgba(0,200,0,0.80)',
            transparentCorners: false
        }).on('selected', function (e) {
            console.log('selected a rectangle');
            console.log(e);
            console.log(this);
            console.log(fabricCanvas.getObjects().indexOf(this));
            document.getElementById("Units").value = Units[fabricCanvas.getObjects().indexOf(this)]['id'];
        }));
        cc('addRec')
        var id = 'Unit_' + (fabricCanvas.getObjects().length - 1);
        document.getElementById("Units").value = id;
        Units.push({"id": id, "type": 'rect'});
    });

    $('#Circle').click(function () {
        fabricCanvas.add(new fabric.Circle({
            radius: 50,
            left: 150,
            top: 50,
            angle: 0,
            originX: 'center',
            originY: 'center',
//            fill: '#aac'
            fill: 'rgba(0,200,0,0.80)',
            transparentCorners: false
        }).on('selected', function (e) {
            console.log('selected a circle');
            console.log(e);
            console.log(this);
            console.log(fabricCanvas.getObjects().indexOf(this));
            document.getElementById("Units").value = Units[fabricCanvas.getObjects().indexOf(this)]['id'];
        }));
        var id = 'Unit_' + (fabricCanvas.getObjects().length - 1);
        document.getElementById("Units").value = id;
        Units.push({"id": id, "type": 'circle'});
    });

    $('#Triangle').click(function () {
        fabricCanvas.add(new fabric.Triangle({
            width: 100,
            height: 100,
            left: 200,
            top: 0,
//            fill: '#cca'
            fill: 'rgba(0,200,0,0.80)',
            transparentCorners: false
        }).on('selected', function (e) {
            console.log('selected a triangle');
            console.log(e);
            console.log(this);
            console.log(fabricCanvas.getObjects().indexOf(this));
            document.getElementById("Units").value = Units[fabricCanvas.getObjects().indexOf(this)]['id'];
        }));
        var id = 'Unit_' + (fabricCanvas.getObjects().length - 1);
        document.getElementById("Units").value = id;
        Units.push({"id": id, "type": 'triangle'});
    });
    $('#Map').click(function () {
        var coordinates = [];
        var features = [];
        $.each(fabricCanvas._objects, function (i, obj) {
            cc('obj');
            cc(obj);
            if (obj.__proto__.type == 'rect') {
                var x0 = obj.oCoords.bl.x, y0 = obj.oCoords.bl.y;
                var x1 = obj.oCoords.br.x, y1 = obj.oCoords.br.y;
                var x2 = obj.oCoords.tr.x, y2 = obj.oCoords.tr.y;
                var x3 = obj.oCoords.tl.x, y3 = obj.oCoords.tl.y;
                var d0 = [];
                d0.push([x0, -y0]);
                d0.push([x1, -y1]);
                d0.push([x2, -y2]);
                d0.push([x3, -y3]);
                d0.push([x0, -y0]);
                coordinates.push(d0);
                features.push({
                    type: "Feature",
                    properties: {unitName: "unit x", unitID: "5555"},
                    geometry: {
                        type: "Polygon",
                        coordinates: coordinates
                    }
                });
            }
            if (obj.__proto__.type == 'circle') {
                var r = obj.radius;
                var a0 = obj.angle;
                var x0 = obj.left;
                var y0 = obj.top;
                var scaleX = obj.scaleX;
                var scaleY = obj.scaleY;
                var d0 = [];
                var x1, y1;
                for (var i = 0; i < 360; i += 10) {
                    var xx, yy;
                    xx = scaleX * r * Math.cos(i * Math.PI / 180);
                    yy = scaleY * r * Math.sin(i * Math.PI / 180);
                    x1 = xx * Math.cos(a0 * Math.PI / 180) - yy * Math.sin(a0 * Math.PI / 180);
                    y1 = xx * Math.sin(a0 * Math.PI / 180) + yy * Math.cos(a0 * Math.PI / 180);
                    d0.push([x0 + x1, -(y0 + y1)]);
                }
                coordinates.push(d0);
                features.push({
                    type: "Feature",
                    properties: {unitName: "unit x", unitID: "xxxx"},
                    geometry: {
                        type: "Polygon",
                        coordinates: coordinates
                    }
                });
            }
            if (obj.__proto__.type == 'triangle') {
                var x0 = obj.oCoords.bl.x, y0 = obj.oCoords.bl.y;
                var x1 = obj.oCoords.br.x, y1 = obj.oCoords.br.y;
                var x2 = obj.oCoords.mt.x, y2 = obj.oCoords.mt.y;
                var d0 = [];
                d0.push([x0, -y0]);
                d0.push([x1, -y1]);
                d0.push([x2, -y2]);
                d0.push([x0, -y0]);
                coordinates.push(d0);
                features.push({
                    type: "Feature",
                    properties: {unitName: "ABCD", unitID: "1234"},
                    geometry: {
                        type: "Polygon",
                        coordinates: coordinates
                    }
                });
            }
        });
        mData = {
            "title": 'myName',
            "features": features
        };
        mJson = Highcharts.geojson(mData);
        $.each(mJson, function (i) {
            this.value = 60 + Math.round((Math.random() * 40)); // Non-random bogus data
        });
        cc(mData);
        mapInit(mJson);
//        cc(canvas);
    });
    $('#remove').click(function () {
        cc('remove');
        cc(fabricCanvas.getActiveGroup());
        if (fabricCanvas.getActiveGroup()) {
            fabricCanvas.getActiveGroup().forEachObject(function (o) {
                fabricCanvas.remove(o)
            });
            fabricCanvas.discardActiveGroup().renderAll();
        } else {
            fabricCanvas.remove(fabricCanvas.getActiveObject());
        }
    });
    $('#BG').click(function () {
        cc('BG');
        setBackground('http://fabricjs.com/assets/jail_cell_bars.png');

    });
    function ss(_string) {
        alert(_string);
    }
    function cc(_object) {
        console.log(_object);
    }

    // 		})();
</script>
<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/maps/modules/drilldown.js"></script>


<div id="container" style="height: 500px; width: 1100px;"></div>
</body>
</html>
