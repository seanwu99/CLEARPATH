<!DOCTYPE html >
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>MES MODULE</title>
    <style>
        body {
            background-image: url("Common/img/logo.png");
            background-size: 180px;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: right 40px top 30px;
            font-family: Arial;
        }

        a.colorButton:link, a.colorButton:active, a.colorButton:hover, a.colorButton:visited {
            text-decoration: none;
            color: #007dc0;
            cursor: pointer;
            background-position: right top;
        }

        #colorButton {
            position: fixed;
            top: 420px;
            left: 1270px;
            width: 100px;
            height: 36px;
            line-height: 36px;
            text-align: left;
            background: #FFF;
            padding: 0 10px 0 0;
            z-index: 200;
            font-family: "Arial Black", Arial, Helvetica, sans-serif;
            -webkit-border-top-right-radius: 21px;
            -moz-border-top-right-radius: 21px;
            -ms-border-top-right-radius: 21px;
            -o-border-top-right-radius: 21px;
            border-top-right-radius: 21px;
            -webkit-border-bottom-right-radius: 21px;
            -moz-border-bottom-right-radius: 21px;
            -ms-border-bottom-right-radius: 21px;
            -o-border-bottom-right-radius: 21px;
            border-bottom-right-radius: 21px;
            border-right: 2px solid #007dc0;
        }

        #app_header {
            padding: 10px;
            padding-left: 40px;
            padding-top: 15px;
            padding-bottom: 0px;
            height: 80px;
            width: 400px;
            text-align: center;
        }

        #app_title {
            width: 400px;
            text-align: center;
            font-family: "Arial Black", Arial, Helvetica, sans-serif;
            font-size: 32px;
            color: #007dc0;
            /*margin-bottom;*/
            /*20px;*/
        }

        #mov_title, #doc_title {
            width: 470px;
            text-align: center;
            font-family: "Arial Black", Arial, Helvetica, sans-serif;
            font-size: 22px;
            color: #007dc0;
            /*margin-bottom;*/
            /*30px;*/
        }

        #app_menu {
            width: 400px;
            text-align: center;
            font-family: Arial, Helvetica, sans-serif;
        }

        #page_title {
            width: 400px;
            text-align: center;
            font-family: "Arial Black", Arial, Helvetica, sans-serif;
            font-size: 28px;
            color: #cfcfcf;
        }

        #mesm_content {
            padding: 30px;
            padding-top: 40px;
        }

        #B-Docs {
            width: 200px;
            margin-top: 10px;
            margin-left: 5px;
            margin-right: 5px;
        }

        .container-stats {
            position: relative;
            margin: 0px 9px;
            float: left;
            font-family: Arial, Helvetica, sans-serif;
        }

        .tile-stats-double {
            position: relative;
            width: 820px;
            display: block;
            margin-bottom: 12px;
            border: 1px solid #E4E4E4;
            -webkit-border-radius: 5px;
            overflow: hidden;
            padding-bottom: 5px;
            -webkit-background-clip: padding-box;
            -moz-border-radius: 5px;
            -moz-background-clip: padding;
            border-radius: 5px;
            background-clip: padding-box;
            background: #FFF;
            transition: all 300ms ease-in-out
        }

        .tile-stats-double .icon {
            width: 20px;
            height: 20px;
            color: #BAB8B8;
            position: absolute;
            right: 53px;
            top: 32px;
            z-index: 1
        }

        .tile-stats-double .count {
            font-size: 38px;
            font-weight: bold;
            line-height: 1.65857
        }

        .tile-stats-double .trans {
            font-family: "Arial Black", Arial, Helvetica, sans-serif;
            font-size: 38px;
            font-weight: bold;
            line-height: 1.85857
            width: 20px;
            height: 24px;
            color: #007dc0;
            position: absolute;
            right: 80px;
            top: 22px;
            z-index: 1
        }

        .tile-stats-double .transTitle {
            font-family: "Arial Black", Arial, Helvetica, sans-serif;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.65857
            width: 40px;
            height: 20px;
            color: #DAD8D8;
            position: absolute;
            right: 37px;
            top: 65px;
            z-index: 1
        }

        .tile-stats-double .count, .tile-stats-double h3, .tile-stats-double p {
            position: relative;
            margin: 0;
            margin-left: 10px;
            z-index: 5;
            padding: 0
        }

        .tile-stats-double h3 {
            margin-top: 5px;
            color: #BAB8B8
        }

        .tile-stats-double p {
            margin-top: 5px;
            font-size: 12px
        }

        .tile-stats-double img {
            zoom: 1.5
        }

        .tile-stats {
            position: relative;
            width: 400px;
            display: block;
            margin-bottom: 12px;
            border: 1px solid #E4E4E4;
            -webkit-border-radius: 5px;
            overflow: hidden;
            padding-bottom: 5px;
            -webkit-background-clip: padding-box;
            -moz-border-radius: 5px;
            -moz-background-clip: padding;
            border-radius: 5px;
            background-clip: padding-box;
            background: #FFF;
            transition: all 300ms ease-in-out
        }

        .tile-stats .icon {
            width: 20px;
            height: 20px;
            color: #BAB8B8;
            position: absolute;
            right: 53px;
            top: 32px;
            z-index: 1
        }

        .tile-stats .count {
            font-size: 38px;
            font-weight: bold;
            line-height: 1.65857
        }

        .tile-stats .count, .tile-stats h3, .tile-stats p {
            position: relative;
            margin: 0;
            margin-left: 10px;
            z-index: 5;
            padding: 0
        }

        .tile-stats h3 {
            color: #BAB8B8
        }

        .tile-stats p {
            margin-top: 5px;
            font-size: 12px
        }

        .tile-stats img {
            zoom: 1.5
        }
    </style>
    <script id="sap-ui-bootstrap"
            src="/sapui5/resources/sap-ui-core.js"
            data-sap-ui-theme="sap_goldreflection"
            data-sap-ui-libs="sap.ui.core,sap.ui.commons,sap.ui.table,sap.ui.ux3,sap.m"
            data-sap-ui-language="en">
    </script>
    <script type="text/javascript" src="Common/js/default.js"></script>

    <script type="text/javascript" id="app-init">
        // ******************************************************************************************************************************************************************
        // Get Core SAP UI5
        var oCore = sap.ui.getCore();
        // Initialize screen
        var nrRows = 13;
        var selectedIndex = -1;

        // ******************************************************************************************************************************************************************
        // initialize access
        var level2Access = "";
        var plant2Access = "";
        // Initialize screen
        var user_name = "";

        var selectedSTATION = 0;
        var selectedSTATION_TXT = "";

        // ****************************************************************************************************************************************************
        function roleSecurity() {
            var myRoles = document.getElementById("user_roles").value;
            var role2Access = "MESM_" + document.getElementById("user_role").value;
            user_name = document.getElementById("user_name").value;
            if (myRoles.indexOf(role2Access) < 0) {
                window.location.assign("security.irpt");
            } else {

                var roleString = document.getElementById("user_role").value;
                var roleArray = roleString.split("_");
                level2Access = roleArray[0];
                // alert("level : " + level2Access);
                plant2Access = roleArray[1];
                // alert("plant : " + plant2Access);

                var role_ADM = "MESM_ADM_" + plant2Access;
                var role_OPS = "MESM_OPS_" + plant2Access;


                selectedSTATION = document.getElementById("user_station").value;
                findUnitID();

                //selectedSTATION = 'P558_ASSY_OP010';

                var tabID = selectedSTATION.split("_");
                if (typeof tabID[2] === "undefined" || tabID[2] === null) tabID[2] = "OP010";
                selectedSTATION_TXT = tabID[1] + " " + tabID[2];

//                cc(selectedSTATION);
//                cc(selectedSTATION_TXT);

                // show status
                setTimeout(function () {
                    getStatus()
                }, 3000);

                switch (role2Access) {
                    case "MESM_ADM_ALL":

                        // update screen
                        document.getElementById("page_title").innerHTML = selectedSTATION_TXT;
                        break;
                    case role_ADM:

                        // update screen
                        document.getElementById("page_title").innerHTML = selectedSTATION_TXT;
                        break;
                    case "MESM_OPS_ALL":

                        // update screen
                        document.getElementById("page_title").innerHTML = selectedSTATION_TXT;

                        break;
                    case role_OPS:

                        // update screen
                        document.getElementById("page_title").innerHTML = selectedSTATION_TXT;

                        break;
                    default:
                        alert("MES Module Role Unknown: " + role2Access);
                        break;
                }
            }
        }
        // ******************************************************************************************************************************************************************
        function getStatus() {
            // document.getElementById("mesm_content").innerHTML = "<center><img src='Common/img/pls_wait.gif' alt='wait ..' /></center>";

            var oReqData;
            if (window.XMLHttpRequest) {
                oReqData = new XMLHttpRequest();
            }
            if (oReqData != null) {
                var timestamp = new Date().getTime();
                var paramStr = "STATION=" + encodeURIComponent(selectedSTATION);
                var queryStr = "/XMII/Runner?Transaction=MESM/STATIONS_HMI/TRANSACTIONS/buildData&OutputParameter=HTML_OUT&Content-Type=text/html&" + paramStr + "&ts=" + timestamp;
//                cc(queryStr);
                oReqData.open("GET", queryStr, true);
                oReqData.onreadystatechange = function () {
                    if (oReqData.readyState == 4)
                        if (oReqData.status == 200) {
                            document.getElementById("mesm_content").innerHTML = " XML Header Received. Processing ...";
                            // Successful -- rebuild the screen
                            stringHTML = oReqData.responseText;
                            document.getElementById("mesm_content").innerHTML = stringHTML;

                            setTimeout(function () {
                                getStatus()
                            }, 3000);
                        } else {
                            alert("Error: " + oReqData.statusText);
                        }
                };
                oReqData.send();
            } else {
                window.alert("Error creating XmlHttpRequest object.");
            }
        }
        // ******************************************************************************************************************************************************************
        var oButtonDocs = new sap.ui.commons.Button({
            id: 'B-Docs',
            text: 'Documentation',
            enabled: true
        });
        oButtonDocs.attachPress(loadDocuments);
        oButtonDocs.placeAt('app_menu');
        // ******************************************************************************************************************************************************************
        function loadDocuments() {
            setTimeout("location.href = '" + "Documents.irpt?ROLE=" + document.getElementById("user_role").value + "&DIR=" + document.getElementById("user_station").value + "'", 0);
            return;
        }
        // ******************************************************************************************************************************************************************
        function cc(obj) {
            console.log(obj)
        }

        var UnitID = '';
        var UnitName = '';
        var OpreationName = '';
        function findUnitID() {
            var lineID = null, lineName = null, opID = null, opName = null;
            var url = "/XMII/Illuminator?QueryTemplate=MESM/STATIONS_HMI/QUERIES/get_FloorMapsData" + "&Content-Type=text/xml";
            getData(url, parseJsonParent);

            function parseJsonParent(jsondata) {
                //selectedSTATION
                for (var i = 0; i < jsondata.length; i++) {
                    if (selectedSTATION.indexOf(jsondata[i]['unitName']) == 0) {
                        lineID = jsondata[i]['recordID'];
                        lineName = jsondata[i]['unitName'];
                    }
                }

                if (lineID != null) {
                    for (var i = 0; i < jsondata.length; i++) {
                        if (jsondata[i]['unitName'] == selectedSTATION.substr(lineName.length + 1) && jsondata[i]['idUnitParent'] == lineID) {
                            opID = jsondata[i]['recordID'];
                            opName = jsondata[i]['unitName'];
                        }
                    }
                }

                if (lineName != null && opName != null) {
                    cc(lineID + '/' + lineName + ' // ' + opID + '/' + opName);
                    UnitID = opID;
                    UnitName = lineName;
                    OpreationName = opName;
                    showButton(UnitID);
                } else {
                    cc('noMatch')
                }
            }
        }

        var alertBtn = false;

        function buttonToggle() {

            if (alertBtn == false) {
                var url = "/XMII/Illuminator?QueryTemplate=MESM/STATIONS_HMI/QUERIES/alertOpen&Param.1=" + UnitID + "&Content-Type=text/xml";
                getData(url, parseJsonParent);
                function parseJsonParent(jsondata) {
                    alertBtn = true;
                    showButton(UnitID);
                }


//                document.getElementById('colorButton').style.borderRight = '2px solid #007dc0';
//                document.getElementById('colorButtonText').style.color = '#007dc0';
//                document.getElementById("colorButtonText").innerHTML = "Alerts OFF";
            } else {
                var url = "/XMII/Illuminator?QueryTemplate=MESM/STATIONS_HMI/QUERIES/alertClose&Param.1=" + UnitID + "&Content-Type=text/xml";
                getData(url, parseJsonParent);
                function parseJsonParent(jsondata) {
                    alertBtn = false;
                    showButton(UnitID);
                }

//                document.getElementById('colorButton').style.borderRight = '2px solid #fc071b';
//                document.getElementById('colorButtonText').style.color = '#fc071b';
//                document.getElementById("colorButtonText").innerHTML = "Alerts ON";

            }

        }

        function showButton(param) {
            var winW, winH;
            if (document.body && document.body.offsetWidth) {
                winW = document.body.offsetWidth;
                winH = document.body.offsetHeight;
            }
            if (document.compatMode == 'CSS1Compat' &&
                document.documentElement &&
                document.documentElement.offsetWidth) {
                winW = document.documentElement.offsetWidth;
                winH = document.documentElement.offsetHeight;
            }
            if (window.innerWidth && window.innerHeight) {
                winW = window.innerWidth;
                winH = window.innerHeight;
            }
//            cc(winW);
//            cc(winH);
//            cc((winW - 825) / 2 + 825);
//            cc('style.left ' + document.getElementById('colorButton').style.left);
            //param
            var url = "/XMII/Illuminator?QueryTemplate=MESM/STATIONS_HMI/QUERIES/alertGetUnitStatus&Param.1=" + param + "&Content-Type=text/xml";
            getData(url, parseJsonParent);
            function parseJsonParent(jsondata) {
//                cc(jsondata[0]['recordID']);
//                cc(jsondata[0]['processed']);
                if (jsondata[0]['processed'] == '1') {
                    alertBtn = false;
                } else {
                    alertBtn = true;
                }
                if (alertBtn == true) {
                    var sLeft = (winW - 825) / 2 + 700;
//                    cc(Math.round(sLeft));
                    document.getElementById('colorButton').style.left = Math.round(sLeft) + 'px';
                    document.getElementById('colorButton').style.borderRight = '2px solid #f7a35c';
                    document.getElementById('colorButtonText').style.color = '#f7a35c';
                    document.getElementById("colorButtonText").innerHTML = "Alert ON";
                    document.getElementById("page_title").innerHTML = OpreationName;

                } else {
                    var sLeft = (winW - 825) / 2 + 700;
//                    cc(Math.round(sLeft));
                    document.getElementById('colorButton').style.left = Math.round(sLeft) + 'px';
                    document.getElementById('colorButton').style.borderRight = '2px solid #7cb5ec';
                    document.getElementById('colorButtonText').style.color = '#7cb5ec';
                    document.getElementById("colorButtonText").innerHTML = "Alert OFF";
                    document.getElementById("page_title").innerHTML = OpreationName;

                }

            }


        }

        colors: [
            '#7cb5ec',
            '#434348',
            '#90ed7d',
            '#f7a35c',
            '#8085e9',
            '#f15c80',
            '#e4d354',
            '#8085e8',
            '#8d4653',
            '#91e8e1'
        ]
    </script>
</head>

<body onLoad="roleSecurity()">

<input id="user_roles" type="hidden" value="{IllumLoginRoles}" style="display:block;width:1000px;" readonly/>
<input id="user_role" type="hidden" value="{ROLE}" style="display:block;width:1000px;" readonly/>
<input id="user_name" type="hidden" value="{IllumLoginName}" style="display: block;width:1000px;" readonly/>
<input id="user_station" type="hidden" value="{STATION}" style="display: block;width:100px;" readonly/>
<input id="user_address" type="hidden" value="{Machine}" style="display:block;width:1000px;" readonly/>
<input id="user_firstname" type="hidden" value="{firstname}" style="display:block;width:800px;" readonly/>
<input id="user_lastname" type="hidden" value="{lastname}" style="display:block;width:800px;" readonly/>
<div id="app_header">
    <div id="app_title">STATION STATUS</div>
    <div id="app_menu"></div>
    <div id="page_title">DEFAULT ROLE</div>
</div>
<div id="mesm_content" style="width:1000px;margin:auto;"></div>
<a id="colorButton" class="colorButton" onclick="buttonToggle()" href="javascript:void(0);"><i id="colorButtonText"></i></a>

</body>
</html>